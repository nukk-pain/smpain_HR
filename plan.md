# Excel 급여업로드 프리뷰 기능 개발 실행 계획

## 개발 목표
Excel 파일 업로드 시 즉시 DB 저장이 아닌, 프리뷰 확인 후 저장하는 2단계 프로세스 구현

## Phase 1: Backend API 개발 (Week 1)

### 1.1 프리뷰 API 구현
- [x] `/api/payroll/excel/preview` 엔드포인트 생성
- [x] Excel 파일 파싱 로직 구현 (기존 LaborConsultantParser 재사용)
- [x] 직원 매칭 검증 로직 구현 (DB 조회만, 저장 안함)
- [x] 중복 급여 기록 체크 로직 구현
- [x] 임시 데이터 저장소 구현 (메모리/MongoDB)
- [x] 프리뷰 토큰 생성 및 관리 로직 구현
- [x] 프리뷰 데이터 응답 포맷 구현
- [x] 에러 및 경고 분석 로직 구현

### 1.2 확인 API 구현
- [x] `/api/payroll/excel/confirm` 엔드포인트 생성
- [x] 프리뷰 토큰 검증 로직 구현
- [x] 임시 저장된 데이터 로드 기능 구현
- [ ] MongoDB 트랜잭션 기반 일괄 저장 구현
- [x] 임시 데이터 정리 로직 구현
- [ ] Idempotency key를 통한 중복 제출 방지 구현

### 1.3 임시 데이터 관리 시스템
- [x] 임시 데이터 저장 구조 설계 및 구현
- [ ] 메모리 사용량 모니터링 및 제한 구현
- [x] 자동 정리 스케줄러 구현 (5분마다 만료 데이터 정리)
- [ ] MongoDB TTL 인덱스 설정 (temp_uploads 컬렉션)
- [ ] 파일 시스템 기반 백업 저장소 구현 (10MB 이상 파일)

### 1.4 보안 강화
- [ ] JWT 기반 프리뷰 토큰 구현
- [ ] CSRF 토큰 검증 로직 추가
- [ ] 민감 정보 마스킹 처리 구현
- [ ] Rate limiting 강화 (5분당 5회 제한)
- [ ] 파일 해시 기반 무결성 검증 구현

### 1.5 Backend 테스트
- [ ] 프리뷰 API 단위 테스트 작성
- [ ] 확인 API 단위 테스트 작성
- [ ] 트랜잭션 롤백 테스트 작성
- [ ] 임시 데이터 만료 테스트 작성
- [ ] 동시성 및 부하 테스트 작성

## Phase 2: Frontend 컴포넌트 개발 (Week 2)

### 2.1 상태 관리 구현
- [ ] UploadState 인터페이스 정의
- [ ] PreviewData 타입 정의
- [ ] 상태 관리 훅 구현 (usePayrollUpload)
- [ ] SessionStorage 기반 상태 복원 로직 구현
- [ ] 브라우저 이탈 경고 구현

### 2.2 프리뷰 컴포넌트 개발
- [ ] PayrollExcelUploadWithPreview 메인 컴포넌트 생성
- [ ] FileSelectStep 컴포넌트 구현
- [ ] PreviewStep 컴포넌트 구현
- [ ] PreviewSummaryCard 컴포넌트 구현
- [ ] PreviewDataTable 컴포넌트 구현 (AG Grid 활용)
- [ ] PreviewErrorList 컴포넌트 구현
- [ ] ResultStep 컴포넌트 구현

### 2.3 데이터 테이블 기능
- [ ] AG Grid 컬럼 정의 (직원정보, 급여, 매칭상태 등)
- [ ] 매칭 상태 표시 칩 구현
- [ ] 에러/경고 하이라이트 구현
- [ ] 페이지네이션 구현
- [ ] 데이터 필터링 기능 구현
- [ ] 금액 포맷팅 및 마스킹 처리 구현

### 2.4 API Service 업데이트
- [ ] previewPayrollExcel 메서드 구현
- [ ] confirmPayrollExcel 메서드 구현
- [ ] 진행률 표시를 위한 SSE 연결 구현
- [ ] 에러 핸들링 및 재시도 로직 구현
- [ ] 기존 uploadPayrollExcel deprecated 처리

### 2.5 사용자 피드백 UI
- [ ] 로딩 상태 표시 컴포넌트 구현
- [ ] 프로그레스 바 구현
- [ ] 에러/경고 알림 시스템 구현
- [ ] 확인 다이얼로그 구현
- [ ] 중복 제출 방지 UI 구현

### 2.6 Frontend 테스트
- [ ] 파일 업로드 플로우 테스트 작성
- [ ] 프리뷰 데이터 렌더링 테스트 작성
- [ ] 상태 관리 테스트 작성
- [ ] 에러 처리 테스트 작성
- [ ] 브라우저 호환성 테스트 작성

## Phase 3: 통합 및 최적화 (Week 3)

### 3.1 통합 테스트
- [ ] 전체 업로드 플로우 E2E 테스트 구현
- [ ] 직원 매칭 실패 시나리오 테스트
- [ ] 중복 데이터 처리 테스트
- [ ] 대용량 파일 처리 테스트
- [ ] 동시 업로드 테스트
- [ ] 세션 만료 및 복원 테스트

### 3.2 성능 최적화
- [ ] 청크 단위 파일 처리 구현
- [ ] 스트리밍 파싱 구현
- [ ] 캐싱 전략 구현
- [ ] 메모리 사용량 최적화
- [ ] API 응답 시간 최적화 (목표: 2초 이하)
- [ ] Frontend 번들 사이즈 최적화

### 3.3 에러 처리 개선
- [ ] 상세 에러 메시지 구현
- [ ] 에러 복구 가이드 제공
- [ ] 부분 실패 처리 로직 구현
- [ ] 롤백 메커니즘 구현
- [ ] 에러 로깅 및 모니터링 구현

### 3.4 운영 도구 개발
- [ ] 관리자용 디버그 API 구현
- [ ] 임시 데이터 모니터링 대시보드
- [ ] 용량 관리 시스템 구현
- [ ] 상세 로깅 시스템 구현
- [ ] 백업 및 복구 시스템 구현

### 3.5 문서화
- [ ] API 문서 작성 (Swagger/OpenAPI)
- [ ] 사용자 가이드 작성
- [ ] 관리자 가이드 작성
- [ ] 트러블슈팅 가이드 작성
- [ ] 마이그레이션 가이드 작성

## Phase 4: 배포 및 모니터링 (Week 4)

### 4.1 Feature Flag 시스템
- [ ] Feature Flag 구현
- [ ] 사용자 그룹별 활성화 로직 구현
- [ ] A/B 테스트 설정
- [ ] 조건부 렌더링 구현
- [ ] 롤백 메커니즘 구현

### 4.2 하위 호환성 유지
- [ ] Adapter 패턴 구현
- [ ] 기존 API 래퍼 구현
- [ ] 환경 변수 기반 모드 전환 구현
- [ ] 레거시 코드 deprecated 표시
- [ ] 마이그레이션 경고 메시지 구현

### 4.3 스테이징 배포
- [ ] 스테이징 환경 설정
- [ ] 배포 스크립트 작성
- [ ] 환경 변수 구성
- [ ] 데이터베이스 마이그레이션 실행
- [ ] 스테이징 테스트 실행

### 4.4 사용자 테스트
- [ ] Beta 사용자 그룹 선정
- [ ] 사용자 테스트 시나리오 작성
- [ ] 피드백 수집 시스템 구현
- [ ] 버그 리포트 처리
- [ ] 성능 메트릭 수집

### 4.5 프로덕션 배포
- [ ] 프로덕션 배포 계획 수립
- [ ] 데이터베이스 백업
- [ ] 블루-그린 배포 실행
- [ ] 모니터링 대시보드 설정
- [ ] 알림 시스템 구성

### 4.6 모니터링 및 개선
- [ ] 실시간 모니터링 설정
- [ ] 성능 지표 추적 (목표 달성 확인)
- [ ] 에러율 모니터링
- [ ] 사용자 피드백 분석
- [ ] 개선사항 도출 및 계획 수립

## 완료 기준

### 성공 지표
- [ ] 업로드 오류율 50% 감소 달성
- [ ] API 응답 시간 2초 이하 유지
- [ ] 메모리 사용량 20% 이내 증가
- [ ] 에러 발생률 1% 이하 유지
- [ ] 사용자 피드백 점수 4.5/5 이상
- [ ] 데이터 정확도 99% 이상

### 필수 완료 항목
- [ ] 모든 테스트 통과
- [ ] 문서화 완료
- [ ] 보안 검토 통과
- [ ] 성능 목표 달성
- [ ] 사용자 승인 획득
- [ ] 프로덕션 안정화 확인

## 위험 요소 및 대응 계획

### 기술적 위험
- **대용량 파일 처리 실패**: 스트리밍 처리 및 청크 분할 구현
- **메모리 부족**: Redis 도입 또는 파일 시스템 활용
- **트랜잭션 실패**: 부분 성공 모드 및 재시도 로직 구현

### 운영적 위험
- **사용자 혼란**: 단계적 배포 및 충분한 교육 제공
- **데이터 손실**: 백업 시스템 구축 및 롤백 계획 수립
- **성능 저하**: 캐싱 및 최적화 지속적 개선

## 다음 단계
1. Phase 1 Backend API 개발 시작
2. 개발 환경 설정 및 필요 패키지 설치
3. 테스트 데이터 준비
4. 개발 진행상황 일일 리뷰

---

**시작 명령**: "go"를 입력하면 첫 번째 미완료 태스크부터 순차적으로 구현을 시작합니다.