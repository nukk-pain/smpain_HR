# FEAT-06: 프론트엔드 리프레시 토큰 통합 계획

## 개요
- 목적: 백엔드 Phase 4(리프레시 토큰, 블랙리스트) 기능을 프론트엔드에 완전 통합하여, 단기 만료 액세스 토큰(예: 15분) 환경에서 자동 갱신과 무중단 사용자 경험을 제공한다.
- 배경: 현재 프론트엔드는 401 응답 시 토큰만 삭제하고 로그인 페이지로 리다이렉트한다. 백엔드에 `/api/auth/refresh` 엔드포인트가 준비되어 있으므로, 인터셉터 기반 자동 갱신으로 사용자 경험과 보안을 동시에 개선한다.
- 범위: 프론트엔드 Axios 인터셉터/토큰 매니저/인증 흐름 정비 + 문서/테스트 보강. 백엔드 변경은 없음(환경 변수와 CORS만 확인).

## 목표
- 자동 토큰 갱신: 401 발생 시(로그인/리프레시 엔드포인트 제외) 백그라운드에서 `/api/auth/refresh` 호출 후 원요청 재시도
- 이중 토큰 관리: `accessToken` + `refreshToken` 저장/회전/폐기 일원화
- 중복 갱신 방지: 동시 401에 대해 단 1회만 리프레시 수행(대기 큐/플래그)
- 하위 호환: 기존 `token` 필드(단일 토큰 모드) 응답도 정상 동작
- 보안 로그: 프로덕션에서 토큰/민감정보 로그 차단

## 변경 범위(파일)
- `frontend/src/services/api.ts`
  - 응답 인터셉터: 401 처리 시 리프레시 로직 추가(재시도 1회, 순차화)
  - 요청 인터셉터: 토큰 주입 로직을 `accessToken` 우선으로 정리
  - 불필요한 `withCredentials: true` 제거(세션 쿠키 미사용 환경)
- `frontend/src/utils/tokenManager.ts`
  - 함수 추가: `storeTokens(access, refresh)`, `getAccessToken()`, `getRefreshToken()`, `clearTokens()`
  - 기존 `getValidToken()`은 accessToken 기준으로 동작하도록 정리
  - 프로덕션 빌드에서 과도한 콘솔 로깅 제거/가드
- `frontend/src/services/authService.ts`(또는 `services/api.ts` 로그인 처리)
  - 로그인 응답 형태 통합 처리: `token`(레거시) | `accessToken + refreshToken` 모두 지원
  - 로그아웃 시 `/auth/logout` 호출 후 토큰 블랙리스트 반영 + 로컬 스토리지 정리
- 문서
  - `docs/development/`에 짧은 사용자/개발자 가이드 추가(옵션)
- 테스트
  - 토큰 매니저 단위 테스트
  - 인터셉터 통합 테스트(401→refresh→재시도 성공/실패)

## 작업 상세
1) 인터셉터 리프레시 설계
- 전역 상태: `isRefreshing`(boolean), `refreshPromise`(Promise|null), `requestQueue`(대기 요청 배열)
- 흐름:
  - 401 수신 시
    - (a) 로그인/리프레시/정적 자원 요청이면 즉시 실패
    - (b) `isRefreshing`이 false면 리프레시 시작 → 성공 시 큐 비움(재시도), 실패 시 전체 실패 처리(로그아웃)
    - (c) `isRefreshing`이 true면 `requestQueue`에 재시도 콜백 등록 후 대기
  - 재시도는 1회만 수행, 재실패 시 로그인 화면으로 이관

2) 토큰 보관 정책
- 저장 키: `hr_access_token`, `hr_refresh_token`
- 만료 체크: accessToken 만료 시점은 디코드로 사전 판단 가능하나, 권장 흐름은 401 기반 갱신(서버 진리원칙)
- 보안: 토큰 원문 로깅 금지(개발 모드에서도 길이/해시 정도만)

3) 로그인/로그아웃 흐름
- 로그인: 응답에 `accessToken` 존재 시 우선 저장, 없으면 `token`을 access로 취급(하위 호환)
- 로그아웃: `/auth/logout` 호출(블랙리스트 반영) → 로컬 토큰 제거 → `/login` 이동

4) 에러/예외 처리
- 리프레시 토큰 만료/무효: 즉시 로그아웃 유도 + 로그인 페이지 이동
- 순환 갱신 방지: 리프레시 실패 시 추가 리프레시 금지
- 경합: 동시 401은 큐잉으로 단일 리프레시만 수행

## 수용 기준(AC)
- 401 응답 시 자동 리프레시 후 원요청 1회 재시도, 최종 성공 응답을 수신한다
- 리프레시 실패/만료 시 모든 대기 요청이 적절히 실패하고 사용자는 로그인 화면으로 이동한다
- 프로덕션에서 토큰/민감정보가 로그에 노출되지 않는다
- 기존 단일 토큰(legacy) 환경에서도 정상 동작한다

## 테스트 계획
- 단위 테스트
  - tokenManager: 저장/조회/삭제/만료 판단, 예외 내성
- 통합 테스트(네트워크 목)
  - 401→refresh 성공→원요청 재시도 성공
  - 동시 401 5건→refresh 1회만 발생, 5건 모두 성공
  - refresh 실패→로그아웃 유도 및 대기 요청 실패
- E2E(옵션)
  - 액세스 토큰 짧게 구성한 스테이징에서 자연 만료 후 무중단 갱신 확인

## 운영 체크리스트
- 백엔드 환경변수: `USE_REFRESH_TOKENS=true`, `REFRESH_TOKEN_SECRET` 설정
- CORS: `/api/auth/refresh` 경로 허용 확인(현재 전역 허용으로 문제 없음)
- 토큰 블랙리스트: `ENABLE_TOKEN_BLACKLIST=true`(선택) 설정 시 로그아웃 후 즉시 무효화 동작 확인

## 작업량/일정(예상)
- 구현: 0.5일
- 테스트/문서: 0.5일
- 합계: 1.0일

## 리스크 및 완화
- 동시성 버그: 큐/플래그 기반 직렬화로 방지, 테스트로 보강
- 레거시 모드 충돌: 분기 처리(응답 스키마 병행 지원)로 회피
- 토큰 유실 시 재귀 401: 재시도 1회 제한으로 사이클 차단

## 완료 정의(DoD)
- FE/BE 스테이징에서 15m 만료 정책으로 수용 기준 충족
- 단위/통합 테스트 통과 및 CI 녹색
- README/개발가이드(간단) 업데이트
- INDEX-PLAN.md에 FEAT-06 항목 추가(대기→진행→완료 업데이트)
