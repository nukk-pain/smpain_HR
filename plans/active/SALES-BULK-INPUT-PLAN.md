# 매출 일괄 입력 시스템 구현 계획

## 목표
개별 매출 입력 방식을 일괄 입력 방식으로 개선하여 월말 매출 데이터 입력 시간을 대폭 단축

## 현재 상황
- 현재: 직원별로 다이얼로그를 열어서 한 명씩 매출 입력
- 문제: 직원이 많을 경우 반복 작업으로 시간 소요가 큼
- 요구: 엑셀처럼 한 화면에서 모든 직원의 매출을 빠르게 입력

## 핵심 요구사항
1. **개인 매출과 전체 매출 분리**: 회사 전체 매출과 개인별 매출은 별도 관리
2. **직원 선택**: 드롭다운에서 직원 선택 (오입력 방지)
3. **통화 단위**: 모든 금액은 원화(₩) 단위

## 구현 계획

### 구현 완료 항목
- ✅ **Phase 1**: 프론트엔드 UI (SalesManagement.tsx)
  - 전체 매출 입력 필드
  - 개인별 매출 테이블 (드롭다운 선택, 기여율 자동 계산)
  - 행 추가/삭제 기능
  - 일괄 저장 버튼

- ✅ **Phase 2**: 백엔드 API (routes/sales.js)
  - GET /api/sales/company/:yearMonth
  - GET /api/sales/individual/:yearMonth
  - POST /api/sales/bulk (트랜잭션 처리)
  - GET /api/sales/stats/:yearMonth
  - DELETE /api/sales/month/:yearMonth

- ✅ **데이터베이스**
  - companySales 컬렉션 생성
  - salesData 컬렉션 수정 (individualSales, contributionRate 필드)

### Phase 1: UI 개선 (프론트엔드)

#### 1.1 SalesManagement 컴포넌트 리팩토링
- [x] 기존 개별 입력 다이얼로그 제거
- [x] 일괄 입력 테이블 구현 (Material-UI Table 사용)
- [x] 인라인 편집 모드 활성화

#### 1.2 매출 입력 구조 (2단계)

##### 1.2.1 전체 매출 입력부
```typescript
// 상단 - 회사 전체 매출 입력
interface CompanySales {
  total_sales: number;      // 회사 전체 매출 (원)
  sales_month: string;       // 매출 월 (yyyy-MM)
  notes: string;            // 전체 매출 관련 메모
}
```

##### 1.2.2 개인별 매출 입력 테이블
```typescript
columns = [
  { 
    field: 'employee_selector', 
    headerName: '직원 선택', 
    cellRenderer: 'EmployeeDropdown',  // 커스텀 드롭다운 컴포넌트
    editable: true,
    cellEditorParams: {
      employees: employeeList  // 직원 목록 전달
    }
  },
  { field: 'individual_sales', headerName: '개인 매출(원)', editable: true, type: 'number' },
  { field: 'contribution_rate', headerName: '기여율(%)', editable: false, calculated: true },  // 전체 매출 대비 개인 기여
  { field: 'notes', headerName: '비고', editable: true }
]
```

#### 1.3 주요 기능
- [x] 행 추가/삭제 기능
- [x] 드롭다운으로 직원 선택
- [x] 기여율 자동 계산
- [x] 탭키로 셀 간 이동
- [x] 엔터키로 다음 행 이동
- [x] 복사/붙여넣기 지원 (엑셀에서 복사한 데이터)
- [x] 변경사항 하이라이트 표시 (undo/redo로 대체)

#### 1.4 데이터 검증
- [x] 음수 입력 방지 (type="number")
- [x] 숫자가 아닌 값 입력 방지
- [x] 필수 필드 체크 (전체 매출, 개인 매출 최소 1명)
- [ ] 비정상적으로 큰 값 경고 (예: 10억 이상)

### Phase 2: 백엔드 API 개선

#### 2.1 일괄 저장 API 구현
- [x] `POST /api/sales/bulk` 엔드포인트 추가
- [x] 트랜잭션 처리로 전체 성공 또는 전체 실패
- [x] 중복 데이터 체크 (같은 월 데이터 덮어쓰기 옵션)
- [x] 변경 이력 저장 (createdBy, updatedBy)

#### 2.2 API 요청/응답 구조
```javascript
// Request
{
  yearMonth: "2025-01",
  companySales: {
    total_amount: 150000000,  // 회사 전체 매출 (원)
    notes: "1월 전체 매출"
  },
  individualSales: [
    { 
      user_id: "123", 
      individual_sales: 5000000,   // 개인 매출 (원)
      notes: "" 
    },
    { 
      user_id: "124", 
      individual_sales: 3000000, 
      notes: "" 
    },
    // ...
  ]
}

// Response
{
  success: true,
  message: "전체 매출 및 15명의 개인 매출 데이터가 저장되었습니다",
  summary: {
    company_total: 150000000,         // 회사 전체 매출
    individual_total: 75000000,       // 개인 매출 합계
    contribution_coverage: 50.0,      // 개인 매출 합계 / 전체 매출 비율
    total_saved: 15
  }
}
```

### Phase 3: UX 개선

#### 3.1 자동 저장
- [x] 3초 디바운스로 자동 임시 저장
- [x] localStorage 활용
- [x] 페이지 새로고침 시 복구 알림 (자동 복구로 개선)

#### 3.2 실행 취소/다시 실행
- [ ] Ctrl+Z / Ctrl+Y 단축키 지원
- [ ] 최대 10단계 히스토리 저장

#### 3.3 진행 상태 표시
- [x] 저장 중 로딩 인디케이터
- [x] 성공/실패 토스트 메시지
- [x] 에러 발생 시 상세 정보 표시

### Phase 4: 성능 최적화

#### 4.1 가상 스크롤
- [ ] 100명 이상 직원 대응
- [ ] AG Grid 가상화 설정

#### 4.2 일괄 처리 최적화
- [ ] 서버: bulk insert 사용
- [ ] 클라이언트: 청크 단위 처리

## 예상 UI 레이아웃

```
┌─────────────────────────────────────────────────────────────────┐
│  2025년 1월 매출 입력                                            │
├─────────────────────────────────────────────────────────────────┤
│  【전체 매출】                                                    │
│  회사 전체 매출: [_______________] 원  비고: [______________]    │
├─────────────────────────────────────────────────────────────────┤
│  【개인별 매출】                           [행 추가] [일괄 저장]   │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┬──────────────┬──────────┬────────────┐│
│  │  직원 선택 ▼     │ 개인매출(원)  │ 기여율%  │    비고    ││
│  ├──────────────────┼──────────────┼──────────┼────────────┤│
│  │ [김철수 ▼]      │   5,000,000  │   3.3    │            ││
│  │ [이영희 ▼]      │   3,500,000  │   2.3    │            ││
│  │ [박민수 ▼]      │   2,000,000  │   1.3    │            ││
│  │ [선택... ▼]     │              │          │            ││
│  └──────────────────┴──────────────┴──────────┴────────────┘│
├─────────────────────────────────────────────────────────────────┤
│  【요약】                                                         │
│  전체 매출: ₩150,000,000 | 개인 매출 합계: ₩75,000,000          │
│  기여율: 50.0% | 입력 완료: 15/20명                              │
└─────────────────────────────────────────────────────────────────┘
```

## 개발 우선순위

1. **필수 (MVP)**
   - AG Grid 일괄 입력 테이블
   - 일괄 저장 API
   - 기본 데이터 검증

2. **중요**
   - 자동 저장
   - 복사/붙여넣기

3. **선택**
   - 실행 취소/다시 실행
   - 고급 검증 규칙
   - 변경 이력 추적

## 테스트 시나리오

### 기능 테스트
- [x] 전체 매출 입력 및 저장
- [x] 직원 드롭다운 선택 (중복 선택 방지)
- [x] 15명 이상 개인 매출 동시 입력
- [ ] 탭/엔터키 네비게이션
- [ ] 복사/붙여넣기 (5행 이상)
- [x] 기여율 자동 계산 (개인매출/전체매출)
- [x] 일괄 저장 성공/실패

### 엣지 케이스
- [ ] 네트워크 끊김 시 자동 저장
- [x] 중복 저장 방지 (트랜잭션으로 덮어쓰기)
- [ ] 대량 데이터 (100명+) 처리
- [ ] 동시 사용자 편집 충돌

### 성능 테스트
- [ ] 100명 데이터 로딩 시간 < 2초
- [ ] 일괄 저장 시간 < 3초
- [ ] 실시간 계산 지연 < 100ms

## 예상 개발 일정

- Phase 1 (UI): 2일
- Phase 2 (API): 1일
- Phase 3 (UX): 1일
- Phase 4 (최적화): 1일
- 테스트: 1일

**총 예상 기간: 5일**

## 기대 효과

- **시간 절감**: 20명 입력 시 20분 → 3분 (85% 감소)
- **오류 감소**: 드롭다운 선택으로 직원명 오입력 방지
- **데이터 일관성**: 전체 매출과 개인 매출 분리 관리
- **분석 용이성**: 기여율 자동 계산으로 성과 분석 개선
- **사용자 만족도**: 일괄 입력으로 편의성 제공
- **데이터 정확성**: 자동 계산 및 검증으로 정확도 향상

## 데이터베이스 스키마 변경 ✅ 완료

### 새로운 컬렉션: companySales ✅ 구현 완료
```javascript
{
  _id: ObjectId,
  yearMonth: "2025-01",
  totalAmount: 150000000,  // 회사 전체 매출 (원)
  notes: "1월 전체 매출",
  createdAt: Date,
  createdBy: userId,
  updatedAt: Date
}
```

### 기존 salesData 컬렉션 수정 ✅ 구현 완료
```javascript
{
  _id: ObjectId,
  userId: ObjectId,
  yearMonth: "2025-01",
  individualSales: 5000000,    // 개인 매출 (원) - 기존 salesAmount 대체
  contributionRate: 3.33,       // 기여율 (%) - 새 필드
  category: "general",
  notes: "",
  createdAt: Date,
  createdBy: userId,
  updatedAt: Date
}
```