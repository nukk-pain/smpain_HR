# 연차 시스템 이슈 수정 계획

## 발견된 이슈
1. **연차 신청 시 승인 전에 추가가 안됨** (한번에 2개를 신청할 수 없음)
2. **잔여연차 남은 개수가 다름** (중복 차감 문제)

## 문제 분석

### 이슈 1: 동시에 여러 개의 연차 신청 불가
**원인**: `backend/routes/leave/leaveRequests.js`의 68-78줄에서 `maxConcurrentRequests` 정책이 1로 설정되어 있음

**현재 로직**:
- 정책 설정: `maxConcurrentRequests: 1` (backend/routes/leave/utils/leaveCalculations.js:172줄)
- pending 상태의 요청이 1개 이상이면 추가 신청 차단 (68-78줄)

**문제점**: 
- 사용자가 여러 날짜의 연차를 계획하고 한꺼번에 신청하려 해도 하나씩만 신청 가능
- 첫 번째 신청이 승인되기 전까지 다음 신청 불가
- 업무 효율성 저하

### 이슈 2: 잔여연차 개수 불일치
**원인**: 중복 라우트 정의와 일부 라우트에서 승인 시 추가 차감

**발견된 중복 라우트**:
1. `leaveRequests.js:452` - 첫 번째 `/:id/approve` (올바른 로직) ✅
   - 승인 시: 이미 차감된 상태 유지
   - 거부 시: 차감된 연차 복구
2. `leaveRequests.js:681` - 두 번째 `/:id/approve` (중복 차감) ❌
   - 716-732줄: 승인 시 추가로 차감 (actualLeaveDays만큼)
3. `leaveApproval.js:117` - 세 번째 `/:id/approve` (중복 차감) ❌
   - 159-174줄: 승인 시 추가로 차감

**문제점**:
- 같은 경로에 대한 중복 정의로 예측 불가능한 동작
- Express는 첫 번째 매칭 라우트를 사용하지만, 라우터 마운트 순서에 따라 달라질 수 있음
- 일부 라우트에서 승인 시 이미 차감된 연차를 또 차감

## 수정 계획

### 1단계: 동시 신청 제한 완화
**파일**: `backend/routes/leave/utils/leaveCalculations.js`

**수정 내용**:
- `maxConcurrentRequests`를 1에서 3으로 변경 (또는 적절한 값)
- 사용자가 최대 3개까지 pending 상태의 연차 신청 가능

```javascript
// 기존 코드 (172줄)
maxConcurrentRequests: 1

// 수정 후
maxConcurrentRequests: 3  // 동시에 3개까지 신청 가능
```

**또는 정책 설정 방법**:
- DB의 leavePolicy 컬렉션에서 설정 변경
- 관리자 페이지에서 설정 가능하도록 UI 추가 고려

### 2단계: 중복 라우트 제거 및 차감 로직 수정
**파일**: `backend/routes/leave/leaveRequests.js`, `backend/routes/leave/leaveApproval.js`

**수정 내용**:

1. **leaveRequests.js:681-739** - 두 번째 `/:id/approve` 라우트 완전 삭제
   - 이 라우트는 중복이며 716-732줄에서 잘못된 추가 차감을 수행

2. **leaveApproval.js:117-181** - `/:id/approve` 라우트에서 차감 로직 제거
   - 159-174줄의 승인 시 추가 차감 로직 삭제
   - 이미 신청 시점에 차감되어 있으므로 승인 시 추가 처리 불필요

3. **유지할 라우트**: leaveRequests.js:452-605의 첫 번째 `/:id/approve`
   - 이 라우트만 남기고 올바른 로직 유지
   - 승인 시: 이미 차감된 상태 유지
   - 거부 시: 차감된 연차 복구

### 3단계: 데이터 정합성 검증 추가
**파일**: `backend/routes/leave/leaveBalance.js`

**수정 내용**:
- 잔액 조회 시 실제 사용된 연차와 DB의 leaveBalance가 일치하는지 검증
- 불일치 시 경고 로그 출력
 
### 4단계: 테스트 시나리오

1. **연속 신청 테스트**:
   - 사용자 A: 잔액 15일
   - 3일 연차 신청 → 잔액 12일 확인
   - 추가로 2일 연차 신청 → 잔액 10일 확인
   - 첫 번째 승인 → 잔액 변화 없음 확인
   - 두 번째 거부 → 잔액 12일로 복구 확인

2. **중복 차감 방지 테스트**:
   - 사용자 B: 잔액 10일
   - 5일 연차 신청 → 잔액 5일 확인
   - 승인 처리 → 잔액 5일 유지 확인 (추가 차감 없음)

3. **취소 복구 테스트**:
   - 승인된 연차 취소 신청
   - 취소 승인 → 잔액 정상 복구 확인

## 구현 우선순위

1. **긴급 (즉시 수정)**:
   - 1단계: 동시 신청 제한 완화 (maxConcurrentRequests 증가)
   - 2단계: 대체 엔드포인트 중복 차감 제거

2. **중요 (다음 단계)**:
   - 3단계: 데이터 정합성 검증 추가
   - 기존 데이터 마이그레이션 스크립트 작성 (중복 차감된 데이터 복구)

3. **개선 사항**:
   - 프론트엔드 API 호출 통일 (대체 엔드포인트 사용 중단)
   - 트랜잭션 처리 개선
   - 상세 로깅 추가

## 영향 범위

- **백엔드**: 
  - `/api/leave` POST (신청)
  - `/api/leave/:id/approve` POST (대체 승인)
  
- **프론트엔드**: 
  - 변경 없음 (백엔드만 수정)
  
- **데이터베이스**:
  - 기존 데이터 정합성 검증 필요
  - 중복 차감된 사용자 데이터 복구 필요

## 예상 소요 시간
- 코드 수정: 30분
- 테스트: 1시간
- 데이터 검증 및 복구: 1시간
- 총 예상: 2.5시간